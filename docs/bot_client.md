
# ๐ ูุณุชูุฏุงุช ฺฉูุงุณ `BotClient` โ ฺฉุชุงุจุฎุงูู `rubpy`

> **ููุจุน:** ุจุฑ ุงุณุงุณ ฺฉุฏ ููุจุน (`bot.py`) ู ุจุงุฒุฎูุฑุฏูุง ุฌุงูุนู ุชูุณุนูโุฏููุฏฺฏุงู  
> **ูุฏู:** ุฑุงูููุง ุฌุงูุน ู ููุง ุจุฑุง ุชุนุงูู ุจุง **Rubika Bot API** (`https://botapi.rubika.ir/v3/<token>/`)  

---

## ๐ ุฎูุงุตู ู ูุฏู

ฺฉูุงุณ `BotClient` ูุณุชู ุงุตู ฺฉุชุงุจุฎุงูู `rubpy` ุงุณุช ู ฺฉ ุฑุงุจุท ูุงููฺฏุงู (async) ุจุฑุง ุณุงุฎุช ุจุงุชโูุง ููุดููุฏ ุฏุฑ ูพูุชูุฑู **Rubika** ูุฑุงูู ูโฺฉูุฏ. ุงู ฺฉูุงุณ ุชูุงู ุงุจุฒุงุฑูุง ูุงุฒู ุจุฑุง ุชูุณุนู ุจุงุชโูุง ูพฺุฏู ู ููุงุณโูพุฐุฑ ุฑุง ุฏุฑ ุงุฎุชุงุฑ ุดูุง ูุฑุงุฑ ูโุฏูุฏ.

### โ ูุงุจูุชโูุง ฺฉูุฏ:
- ูพุดุชุจุงู ุงุฒ **Polling** ู **Webhook** ุจุฑุง ุฏุฑุงูุช ุขูพุฏุช
- ุซุจุช ููุฏูุฑูุง ููุดููุฏ ุจุง **ููุชุฑูุง ูุฏุฑุชููุฏ**
- ุงุฑุณุงู ุงููุงุน ูุญุชูุง: ูพุงูุ ูุงูุ ุงุณุชฺฉุฑุ ูุธุฑุณูุฌุ ูููุนุชุ ูุฎุงุทุจ
- ูุฏุฑุช ฺฉุจูุฑุฏูุง ฺุช ู ุฏฺฉููโูุง ุชุนุงูู
- ุขูพููุฏ ู ุฏุงูููุฏ ูุงู ุจุง ูพุดุชุจุงู ุงุฒ **ูพุดุฑูุช ุนููุงุช**
- ูุญุฏูุฏุช ูุฑุฎ ุฏุงุฎู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุจูุงฺฉ ุดุฏู
- ุงูู ุฏุฑ ููุฒูุงู ุจุง ูพุดุชุจุงู ุงุฒ ููุฏูุฑูุง ููฺฏุงู ู ูุงููฺฏุงู

---

## ๐๏ธ ูพุดโูุงุฒูุง

### ๐ง ูุงุจุณุชฺฏโูุง
- **ูพุงุชูู:** ณ.ธ+
- **ฺฉุชุงุจุฎุงููโูุง:**
- `aiohttp` โ ุจุฑุง ุฏุฑุฎูุงุณุชโูุง HTTP ูุงููฺฏุงู
- `rubpy` โ ฺฉุชุงุจุฎุงูู ุงุตู
- **ุชูฺฉู ุจุงุช:** ุงุฒ ุฑุจุงุช @BotFather ุฏุฑุงูุช ฺฉูุฏ

### ๐ฆ ูุตุจ
```bash
pip install -U rubpy
```

### ๐ฅ ูุงุฑุฏ ฺฉุฑุฏู ูุงฺููโูุง
```python
import asyncio
from typing import Optional
from rubpy import BotClient
from rubpy.bot import filters
from rubpy.bot.enums import UpdateTypeEnum, ChatKeypadTypeEnum
from rubpy.bot.models import Keypad, Update
```

---

## ๐๏ธ ูุนูุงุฑ ฺฉู

`BotClient` ฺฉ ุณุงุฎุชุงุฑ ูุงููฺฏุงู ู ุฑูุฏุงุฏูุญูุฑ ุฏุงุฑุฏ ฺฉู ุจุฑ ูพุงู `asyncio` ู `aiohttp` ุณุงุฎุชู ุดุฏู ุงุณุช.

### ๐ ูุฏูโูุง ุฏุฑุงูุช ุขูพุฏุช

| ูุฏู | ุชูุถุญ | ูพุดููุงุฏ |
|-----|------|--------|
| **Polling** | ุฏุฑุงูุช ุฏูุฑูโุง ุขูพุฏุช ุงุฒ ุณุฑูุฑ | ููุงุณุจ ุจุฑุง ุชูุณุนู ู ุชุณุช |
| **Webhook** | ุงุฑุณุงู ุขูพุฏุช ุชูุณุท ุณุฑูุฑ ุจู URL ุดูุง | ููุงุณุจ ุจุฑุง ูุญุท ุชููุฏ |

### ๐ ฺุฑุฎู ูพุฑุฏุงุฒุด ุขูพุฏุช:
1. ุฏุฑุงูุช ุฏุงุฏู ุฎุงู ุงุฒ API
2. ุชุญูู ุจู ุดุก `Update` ุง `InlineMessage`
3. ููุชุฑ ูพุงูโูุง ูุฏู (ุจุด ุงุฒ ต ุซุงูู)
4. ุฌููฺฏุฑ ุงุฒ ูพุฑุฏุงุฒุด ุชฺฉุฑุงุฑ ุจุง `processed_messages`
5. ุงุฌุฑุง ููุฏูุฑูุง ูุชูุงุณุจ ุจุง ููุชุฑูุง

---

## ๐งฑ ูุฏูโูุง ฺฉูุฏ

ูุฏูโูุง ุจุง ุงุณุชูุงุฏู ุงุฒ `dataclass` ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ ู ุฏุงุฏูโูุง ุฑุง ุจู ุตูุฑุช ุณุงุฎุชุงุฑุงูุชู ูุฏุฑุช ูโฺฉููุฏ.

| ูุฏู | ุชูุถุญ |
|-----|-------|
| `Update` | ุดุงูู ููุน ุขูพุฏุชุ ุดูุงุณู ฺุชุ ูพุงู ุฌุฏุฏ/ูุฑุงุดโุดุฏู/ุญุฐูโุดุฏู |
| `InlineMessage` | ูพุงูโูุง ุงุฑุณุงู ุงุฒ ุทุฑู ุฏฺฉููโูุง ุชุนุงูู |
| `Message` | ุณุงุฎุชุงุฑ ฺฉุงูู ูพุงู (ูุชูุ ุฒูุงูุ ูุงูุ ู ุบุฑู) |
| `MessageId` | ุดูุงุณู ูพุงู ู ูุงู |
| `Keypad` | ฺฉุจูุฑุฏ ฺุช ุง ุฏฺฉููโูุง inline |

### ๐ค enumูุง ููู:
- `UpdateTypeEnum`: `NEW_MESSAGE`, `UPDATED_MESSAGE`, `REMOVED_MESSAGE`
- `ChatKeypadTypeEnum`: `NONE`, `NEW`, `REPLACE`, `REMOVE`

---

## ๐ ุดุฑูุน ุจู ฺฉุงุฑ

### ุณุงุฎุช ููููู
```python
client = BotClient(
    token="YOUR_BOT_TOKEN",
    rate_limit=0.5,          # ุชุฃุฎุฑ ุจู ุฏุฑุฎูุงุณุชโูุง (ุซุงูู)
    use_webhook=False        # True ุจุฑุง ูุจููฺฉ
)
```

### ูุฏุฑุช ฺุฑุฎู ุนูุฑ
```python
await client.start()   # ุดุฑูุน ุฌูุณู
await client.run()     # ุงุฌุฑุง ุจุงุช (Polling ุง Webhook)
await client.stop()    # ูพุงุงู ุฌูุณู
```

---

## ๐ก ูุชุฏูุง ุงุตู

### ๐ฅ ุงุฑุณุงู ูุญุชูุง
| ูุชุฏ | ุชูุถุญ |
|------|--------|
| `send_message(chat_id, text)` | ุงุฑุณุงู ูพุงู ูุชู |
| `send_sticker(chat_id, sticker_id)` | ุงุฑุณุงู ุงุณุชฺฉุฑ |
| `send_file(chat_id, file, type)` | ุงุฑุณุงู ูุงู (ุชุตูุฑุ ุตุฏุงุ ูุฏู ู ...) |
| `send_poll(chat_id, question, options)` | ุงุฑุณุงู ูุธุฑุณูุฌ |
| `send_location(chat_id, lat, lon)` | ุงุฑุณุงู ูููุนุช ุฌุบุฑุงูุง |
| `send_contact(chat_id, first, last, phone)` | ุงุฑุณุงู ูุฎุงุทุจ |

### ๐ ูุฏุฑุช ูพุงู
| ูุชุฏ | ุชูุถุญ |
|------|--------|
| `edit_message_text(chat_id, msg_id, text)` | ูุฑุงุด ูุชู ูพุงู |
| `delete_message(chat_id, msg_id)` | ุญุฐู ูพุงู |
| `forward_message(from_id, msg_id, to_id)` | ููุฑูุงุฑุฏ ูพุงู |

### ๐ ูุฏุฑุช ูุงู
| ูุชุฏ | ุชูุถุญ |
|------|--------|
| `request_send_file(type)` | ุฏุฑุงูุช ุขุฏุฑุณ ุขูพููุฏ |
| `upload_file(url, path, name)` | ุขูพููุฏ ูุงู |
| `get_file(file_id)` | ุฏุฑุงูุช ููฺฉ ุฏุงูููุฏ |
| `download_file(file_id, save_as, progress)` | ุฏุงูููุฏ ุจุง ูพุดุฑูุช |

### ๐ ูุจููฺฉ
```python
await client.run(
    webhook_url="https://your-domain.com/bot",
    path="/bot",
    host="0.0.0.0",
    port=8080
)
```

---

## ๐ฏ ุซุจุช ููุฏูุฑูุง

ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏฺฉูุฑุงุชูุฑ `@on_update` ู ููุชุฑูุงุ ุฑูุฏุงุฏูุง ุฑุง ูุฏุฑุช ฺฉูุฏ:

```python
@client.on_update(filters.commands("start"))
async def welcome(client, update):
    await update.reply("ุณูุงู! ุจู ุจุงุช ุฎูุด ุขูุฏุฏ.")
```

### ููุชุฑูุง ูพุดโุณุงุฎุชู:
- `filters.text` โ ููุท ูพุงูโูุง ูุชู
- `filters.photo` โ ุชุตุงูุฑ
- `filters.private` โ ฺุช ุฎุตูุต
- `filters.group` โ ฺฏุฑูู
- `filters.commands("start")` โ ุฏุณุชูุฑุงุช ุฎุงุต

### ููุชุฑ ุณูุงุฑุด:
```python
class ContainsHelloFilter(filters.Filter):
    async def check(self, update):
        return "ุณูุงู" in (update.new_message.text or "")
```

---

## โ๏ธ ุจูุชุฑู ุดููโูุง

1. **ูุฏุฑุช ุฌูุณู:** ููุดู ุงุฒ `try/finally` ุงุณุชูุงุฏู ฺฉูุฏ.
2. **ูุญุฏูุฏุช ูุฑุฎ:** ุฏุฑ ุจุงุชโูุง ูพุฑฺฉุงุฑุจุฑุ `rate_limit=1` ุชูุธู ฺฉูุฏ.
3. **SSL:** ุฏุฑ ุชููุฏุ `ssl=True` ุฑุง ูุนุงู ฺฉูุฏ.
4. **ูุงฺฏโฺฏุฑ:** ุจุฑุง ุฏุจุงฺฏุ `logging.DEBUG` ุฑุง ูุนุงู ฺฉูุฏ.
5. **ูุจููฺฉ:** ุงุฒ ุฏุงููู HTTPS ู ุณุฑูุฑ ูพุงุฏุงุฑ ุงุณุชูุงุฏู ฺฉูุฏ.

---

## ๐ ูุฏุฑุช ุฎุทุงูุง

### ุฎุทุงูุง ุฑุงุฌ:
- `ClientResponseError` โ ูุดฺฉู ุฏุฑ ุงุฑุชุจุงุท ุจุง API
- `ValueError` โ ูพุงุฑุงูุชุฑ ูุงูุนุชุจุฑ
- `JSONDecodeError` โ ุฏุงุฏู ูุงูุนุชุจุฑ ุฏุฑ Webhook

### ูุนุงูโุณุงุฒ ูุงฺฏ:
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

---

## ๐งช ูุซุงูโูุง ฺฉุงุฑุจุฑุฏ

### ฑ. ุจุงุช ุณุงุฏู ุจุง ฺฉุจูุฑุฏ
```python
from rubpy import BotClient
from rubpy.bot import filters
from rubpy.bot.models import Keypad, KeypadRow, Button

client = BotClient("TOKEN")

@client.on_update(filters.commands("start"))
async def start(client, update):
    keypad = Keypad(
        rows=[KeypadRow(buttons=[Button(id="1", button_text="ุดุฑูุน")])],
        resize_keyboard=True
    )
    await update.reply("ุจู ุจุงุช ุฎูุด ุขูุฏุฏ!", chat_keypad=keypad)

client.run()
```

### ฒ. ุจุงุช ูุจููฺฉ
```python
await client.run(webhook_url="https://example.com/bot", path="/bot")
```

### ณ. ุฏุงูููุฏ ูุงู ุจุง ูพุดุฑูุช
```python
def progress(downloaded, total):
    print(f"ุฏุฑุงูุช: {downloaded}/{total} ุจุงุช")

await client.download_file("file123", "photo.jpg", progress=progress)
```

---

## โ ุณูุงูุงุช ูุชุฏุงูู

**ุณ: ฺุฑุง ุขูพุฏุชโูุง ุฏุฑุงูุช ููโุดููุฏุ**  
ุฌ: ูุทูุฆู ุดูุฏ `has_time_passed` ูุนุงู ุงุณุช ุง ูุงฺฏ ุฑุง ุฏุฑ ุณุทุญ `DEBUG` ุจุฑุฑุณ ฺฉูุฏ.

**ุณ: ฺุทูุฑ ููุชุฑ ุณูุงุฑุด ุจููุณูุ**  
ุฌ: ฺฉ ฺฉูุงุณ ุงุฒ `filters.Filter` ุงุฑุซโุจุฑ ฺฉูุฏ ู ูุชุฏ `check` ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ.

**ุณ: ุขุง ุขูพููุฏ ุชฺฉูโุชฺฉู (chunked) ูพุดุชุจุงู ูโุดูุฏุ**  
ุฌ: ุฎุฑุ ุงูุง ุฏุฑ ุขูุฏู ุงุถุงูู ุฎูุงูุฏ ุดุฏ.

---

## ๐ ูพูุณุช: ูุซุงู ูพุดุฑูุชู

### ุจุงุช ุจุง ููุชุฑ ุณูุงุฑุด ู ููุฏูุฑ ููฺฏุงู
```python
class GreetingFilter(filters.Filter):
    async def check(self, update):
        text = update.new_message.text or ""
        return any(word in text.lower() for word in ["ุณูุงู", "ูุง", "hello"])

@app.on_update(GreetingFilter())
def greet_sync(client, update):
    update.reply("ุฏุฑูุฏ! ฺุทูุฑุ")
```
---

**ุทุฑุงุญ ุดุฏู ุจุง โค๏ธ ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู ูุงุฑุณโุฒุจุงู** 

